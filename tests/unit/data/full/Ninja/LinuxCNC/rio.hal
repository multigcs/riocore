
# load the realtime components
loadrt [KINS]KINEMATICS
loadrt [EMCMOT]EMCMOT base_period_nsec=[EMCMOT]BASE_PERIOD servo_period_nsec=[EMCMOT]SERVO_PERIOD num_joints=[KINS]JOINTS num_dio=[EMCMOT]NUM_DIO num_aio=[EMCMOT]NUM_AIO

# pid controller
loadrt pid num_chan=3

# manual toolchanger
loadusr -W hal_manualtoolchange

# stepgen-ninja
loadrt stepgen-ninja ip_address="192.168.0.177:8888"

loadusr -W hal_input -KRAL Joystick
loadrt mux4 names=joy_mux4

# read
addf stepgen-ninja.0.watchdog-process servo-thread
addf stepgen-ninja.0.process-send servo-thread
# process
addf pid.0.do-pid-calcs servo-thread
addf pid.1.do-pid-calcs servo-thread
addf pid.2.do-pid-calcs servo-thread
addf motion-command-handler servo-thread
addf motion-controller servo-thread
addf joy_mux4 servo-thread
# write
addf stepgen-ninja.0.process-recv servo-thread

#################################################################################
# logic and calc components
#################################################################################
loadrt logic names=func.or_0.1,func.or_1.1 personality=0x202,0x202
addf func.or_0.1 servo-thread
addf func.or_1.1 servo-thread

loadrt conv_s32_u32 names=func.conv_s32_u32-1
addf func.conv_s32_u32-1 servo-thread

#################################################################################
# &iocontrol.0.user-enable-out --> iocontrol.0.emc-enable-in
#################################################################################
net estop-out                      <= iocontrol.0.user-enable-out
net estop-out                      => iocontrol.0.emc-enable-in

#################################################################################
# iocontrol.0.tool-prep-number --> hal_manualtoolchange.number
#################################################################################
net tool-prep-number               <= iocontrol.0.tool-prep-number
# net tool-prep-number               => hal_manualtoolchange.number (in postgui)

#################################################################################
# iocontrol.0.tool-change --> hal_manualtoolchange.change
#################################################################################
net tool-change                    <= iocontrol.0.tool-change
# net tool-change                    => hal_manualtoolchange.change (in postgui)

#################################################################################
# hal_manualtoolchange.changed --> iocontrol.0.tool-changed
#################################################################################
# net tool-changed                   <= hal_manualtoolchange.changed (in postgui)
net tool-changed                   => iocontrol.0.tool-changed

#################################################################################
# iocontrol.0.tool-prepare --> iocontrol.0.tool-prepared
#################################################################################
net tool-prepared                  <= iocontrol.0.tool-prepare
net tool-prepared                  => iocontrol.0.tool-prepared

#################################################################################
# input.0.btn-top2 or input.0.btn-pinkie --> joy_mux4.sel0
#################################################################################
net sig_input_0_btn-top2           <= input.0.btn-top2
net sig_input_0_btn-pinkie         <= input.0.btn-pinkie
net sig_input_0_btn-top2           => func.or_0.1.in-00
net sig_input_0_btn-pinkie         => func.or_0.1.in-01
net func_or_0_1_or                 <= func.or_0.1.or
net func_or_0_1_or                 => joy_mux4.sel0

#################################################################################
# input.0.btn-base or input.0.btn-pinkie --> joy_mux4.sel1
#################################################################################
net sig_input_0_btn-base           <= input.0.btn-base
net sig_input_0_btn-base           => func.or_1.1.in-00
net sig_input_0_btn-pinkie         => func.or_1.1.in-01
net func_or_1_1_or                 <= func.or_1.1.or
net func_or_1_1_or                 => joy_mux4.sel1

#################################################################################
# joy_mux4.out --> halui.axis.jog-speed
#################################################################################
net sig_joy_mux4_out               <= joy_mux4.out
net sig_joy_mux4_out               => halui.axis.jog-speed

#################################################################################
# joy_mux4.out --> halui.joint.jog-speed
#################################################################################
net sig_joy_mux4_out               => halui.joint.jog-speed

#################################################################################
# halui.machine.is-on --> mux2_x.sel
#################################################################################
net sig_halui_machine_is-on        <= halui.machine.is-on
net sig_halui_machine_is-on        => mux2_x.sel

#################################################################################
# input.0.abs-x-position --> mux2_x.in1
#################################################################################
net sig_input_0_abs-x-position     <= input.0.abs-x-position
net sig_input_0_abs-x-position     => mux2_x.in1

#################################################################################
# mux2_x.out --> halui.axis.x.analog
#################################################################################
net sig_mux2_x_out                 <= mux2_x.out
net sig_mux2_x_out                 => halui.axis.x.analog

#################################################################################
# mux2_x.out --> halui.joint.0.analog
#################################################################################
net sig_mux2_x_out                 => halui.joint.0.analog

#################################################################################
# halui.machine.is-on --> mux2_y.sel
#################################################################################
net sig_halui_machine_is-on        => mux2_y.sel

#################################################################################
# input.0.abs-y-position --> mux2_y.in1
#################################################################################
net sig_input_0_abs-y-position     <= input.0.abs-y-position
net sig_input_0_abs-y-position     => mux2_y.in1

#################################################################################
# mux2_y.out --> halui.axis.y.analog
#################################################################################
net sig_mux2_y_out                 <= mux2_y.out
net sig_mux2_y_out                 => halui.axis.y.analog

#################################################################################
# mux2_y.out --> halui.joint.1.analog
#################################################################################
net sig_mux2_y_out                 => halui.joint.1.analog

#################################################################################
# halui.machine.is-on --> mux2_z.sel
#################################################################################
net sig_halui_machine_is-on        => mux2_z.sel

#################################################################################
# input.0.abs-rz-position --> mux2_z.in1
#################################################################################
net sig_input_0_abs-rz-position    <= input.0.abs-rz-position
net sig_input_0_abs-rz-position    => mux2_z.in1

#################################################################################
# mux2_z.out --> halui.axis.z.analog
#################################################################################
net sig_mux2_z_out                 <= mux2_z.out
net sig_mux2_z_out                 => halui.axis.z.analog

#################################################################################
# mux2_z.out --> halui.joint.2.analog
#################################################################################
net sig_mux2_z_out                 => halui.joint.2.analog

#################################################################################
# stepgen-ninja.0.input.gp8-not --> joint.0.home-sw-in
#################################################################################
net sig_stepgen-ninja_0_input_gp8-not <= stepgen-ninja.0.input.gp8-not
net sig_stepgen-ninja_0_input_gp8-not => joint.0.home-sw-in

#################################################################################
# stepgen-ninja.0.input.gp9-not --> joint.1.home-sw-in
#################################################################################
net sig_stepgen-ninja_0_input_gp9-not <= stepgen-ninja.0.input.gp9-not
net sig_stepgen-ninja_0_input_gp9-not => joint.1.home-sw-in

#################################################################################
# stepgen-ninja.0.input.gp10-not --> joint.2.home-sw-in
#################################################################################
net sig_stepgen-ninja_0_input_gp10-not <= stepgen-ninja.0.input.gp10-not
net sig_stepgen-ninja_0_input_gp10-not => joint.2.home-sw-in

#################################################################################
# spindle.0.on --> stepgen-ninja.0.output.gp26
#################################################################################
net sig_spindle_0_on               <= spindle.0.on
net sig_spindle_0_on               => stepgen-ninja.0.output.gp26

#################################################################################
# pyvcp.halui.mdi-command-00 --> halui.mdi-command-00
#################################################################################
# net sig_pyvcp_halui_mdi-command-00 <= pyvcp.halui.mdi-command-00 (in postgui)
net sig_pyvcp_halui_mdi-command-00 => halui.mdi-command-00

#################################################################################
# pyvcp.halui.mdi-command-01 --> halui.mdi-command-01
#################################################################################
# net sig_pyvcp_halui_mdi-command-01 <= pyvcp.halui.mdi-command-01 (in postgui)
net sig_pyvcp_halui_mdi-command-01 => halui.mdi-command-01

#################################################################################
# pyvcp.halui.mdi-command-02 --> halui.mdi-command-02
#################################################################################
# net sig_pyvcp_halui_mdi-command-02 <= pyvcp.halui.mdi-command-02 (in postgui)
net sig_pyvcp_halui_mdi-command-02 => halui.mdi-command-02

#################################################################################
# stepgen-ninja.0.input.gp8-not --> pyvcp.stepgen-ninja.0.input.gp8-not
#################################################################################
# net sig_stepgen-ninja_0_input_gp8-not => pyvcp.stepgen-ninja.0.input.gp8-not (in postgui)

#################################################################################
# stepgen-ninja.0.input.gp9-not --> pyvcp.stepgen-ninja.0.input.gp9-not
#################################################################################
# net sig_stepgen-ninja_0_input_gp9-not => pyvcp.stepgen-ninja.0.input.gp9-not (in postgui)

#################################################################################
# stepgen-ninja.0.input.gp10-not --> pyvcp.stepgen-ninja.0.input.gp10-not
#################################################################################
# net sig_stepgen-ninja_0_input_gp10-not => pyvcp.stepgen-ninja.0.input.gp10-not (in postgui)

#################################################################################
# conv(pyvcp.stepgen-ninja.0.pwm.0.duty-i, s32, u32) --> stepgen-ninja.0.pwm.0.duty
#################################################################################
# net sig_pyvcp_stepgen-ninja_0_pwm_0_duty-i <= pyvcp.stepgen-ninja.0.pwm.0.duty-i (in postgui)
net sig_pyvcp_stepgen-ninja_0_pwm_0_duty-i => func.conv_s32_u32-1.in
net func_conv_s32_u32-1_out        <= func.conv_s32_u32-1.out
net func_conv_s32_u32-1_out        => stepgen-ninja.0.pwm.0.duty

#################################################################################
# pyvcp.stepgen-ninja.0.pwm.0.enable --> stepgen-ninja.0.pwm.0.enable
#################################################################################
# net sig_pyvcp_stepgen-ninja_0_pwm_0_enable <= pyvcp.stepgen-ninja.0.pwm.0.enable (in postgui)
net sig_pyvcp_stepgen-ninja_0_pwm_0_enable => stepgen-ninja.0.pwm.0.enable

#################################################################################
# stepgen-ninja.0.output.gp26 --> pyvcp.stepgen-ninja.0.output.gp26
#################################################################################
# net sig_spindle_0_on               => pyvcp.stepgen-ninja.0.output.gp26 (in postgui)

#################################################################################
# pyvcp.stepgen-ninja.0.output.gp25 --> stepgen-ninja.0.output.gp25
#################################################################################
# net sig_pyvcp_stepgen-ninja_0_output_gp25 <= pyvcp.stepgen-ninja.0.output.gp25 (in postgui)
net sig_pyvcp_stepgen-ninja_0_output_gp25 => stepgen-ninja.0.output.gp25

#################################################################################
# pyvcp.stepgen-ninja.0.output.gp29 --> stepgen-ninja.0.output.gp29
#################################################################################
# net sig_pyvcp_stepgen-ninja_0_output_gp29 <= pyvcp.stepgen-ninja.0.output.gp29 (in postgui)
net sig_pyvcp_stepgen-ninja_0_output_gp29 => stepgen-ninja.0.output.gp29

#################################################################################
# joint-0
#################################################################################
setp stepgen-ninja.0.stepgen.0.step-scale [JOINT_0]SCALE_OUT
net j0pos-cmd                      <= joint.0.motor-pos-cmd
net j0enable                       <= joint.0.amp-enable-out
net j0pos-cmd                      => stepgen-ninja.0.stepgen.0.command
net j0pos-cmd                      => joint.0.motor-pos-fb
net j0enable                       => stepgen-ninja.0.stepgen.0.enable

#################################################################################
# joint-1
#################################################################################
setp stepgen-ninja.0.stepgen.1.step-scale [JOINT_1]SCALE_OUT
net j1pos-cmd                      <= joint.1.motor-pos-cmd
net j1enable                       <= joint.1.amp-enable-out
net j1pos-cmd                      => stepgen-ninja.0.stepgen.1.command
net j1pos-cmd                      => joint.1.motor-pos-fb
net j1enable                       => stepgen-ninja.0.stepgen.1.enable

#################################################################################
# joint-2
#################################################################################
setp stepgen-ninja.0.stepgen.2.step-scale [JOINT_2]SCALE_OUT
net j2pos-cmd                      <= joint.2.motor-pos-cmd
net j2enable                       <= joint.2.amp-enable-out
net j2pos-cmd                      => stepgen-ninja.0.stepgen.2.command
net j2pos-cmd                      => joint.2.motor-pos-fb
net j2enable                       => stepgen-ninja.0.stepgen.2.enable

#################################################################################
# setp
#################################################################################
setp input.0.abs-rz-scale             -127.5
setp input.0.abs-x-scale              127.5
setp input.0.abs-y-scale              -127.5
setp joy_mux4.in0                     0.0
setp joy_mux4.in1                     50.0
setp joy_mux4.in2                     500.0
setp joy_mux4.in3                     2000.0
setp stepgen-ninja.0.pwm.0.frequency   10000
setp stepgen-ninja.0.pwm.0.max-scale   100
setp stepgen-ninja.0.pwm.0.min-limit   0
setp stepgen-ninja.0.stepgen.0.mode   False
setp stepgen-ninja.0.stepgen.1.mode   False
setp stepgen-ninja.0.stepgen.2.mode   False

#################################################################################
# preformated
#################################################################################
loadrt mux2 names=mux2_x,mux2_y,mux2_z
addf mux2_x servo-thread
addf mux2_y servo-thread
addf mux2_z servo-thread
